<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Widget TRM - Conversor</title>
<meta name="robots" content="noindex,nofollow" />
<style>
  :root{
    --card:#055b63; --accent:#ff8a00; --muted:#666; --bg:#ffffff;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body{margin:0;background:var(--bg);display:flex;min-height:100vh;align-items:flex-start;justify-content:center;padding:18px}
  .wrap{width:340px;border-radius:10px;padding:12px;border:3px solid var(--card);box-shadow:0 8px 20px rgba(0,0,0,.07);background:#fff}
  h1{margin:0 0 8px;font-size:15px;color:#fff;background:var(--card);padding:8px;border-radius:6px}
  .row{display:flex;gap:8px;align-items:center}
  .rate{font-size:22px;font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  input[type="number"]{padding:8px;border-radius:6px;border:1px solid #ddd;font-size:15px;flex:1}
  select{padding:8px;border-radius:6px;border:1px solid #ddd}
  button{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
  .result{font-weight:700;font-size:18px;margin-top:8px}
  footer{margin-top:10px;font-size:12px;color:var(--muted);text-align:left}
  .small{font-size:12px;color:var(--muted)}
  .error{color:#c0392b;font-weight:600}
</style>
</head>
<body>
  <div class="wrap" id="widget">
    <h1>TRM - Conversor (en vivo)</h1>

    <div class="row" style="justify-content:space-between">
      <div>
        <div class="small">TRM (USD → COP)</div>
        <div class="rate" id="trmValue">—</div>
        <div class="muted small" id="trmDate">cargando...</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <button id="refreshBtn" title="Actualizar ahora">Actualizar</button>
        <div class="small muted" id="status">Estado: inicializando...</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="small">Conversión</div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <input id="amount" type="number" step="0.01" placeholder="Cantidad (ej: 100)" value="1"/>
        <select id="direction">
          <option value="usd_to_cop">USD → COP</option>
          <option value="cop_to_usd">COP → USD</option>
        </select>
      </div>
      <div class="result" id="result">—</div>
      <div class="small muted" id="updateInfo">Última actualización: —</div>
    </div>

    <footer>
      Fuente: <span class="small">open.er-api.com (tasa USD→COP)</span>
    </footer>
  </div>

<script>
/*
 Widget TRM + conversor usando https://open.er-api.com/v6/latest/USD
 Auto-refresca cada REFRESH_SECONDS segundos. Maneja errores y muestra estados.
*/
(function(){
  const API_URL = 'https://open.er-api.com/v6/latest/USD';
  const REFRESH_SECONDS = 60;

  const trmValueEl = document.getElementById('trmValue');
  const trmDateEl = document.getElementById('trmDate');
  const amountEl = document.getElementById('amount');
  const directionEl = document.getElementById('direction');
  const resultEl = document.getElementById('result');
  const updateInfoEl = document.getElementById('updateInfo');
  const statusEl = document.getElementById('status');
  const refreshBtn = document.getElementById('refreshBtn');

  let currentTRM = null;
  let timerId = null;

  function fmt(n){
    if(n==null || isNaN(n)) return '—';
    return Number(n).toLocaleString('es-CO', {maximumFractionDigits:2});
  }

  async function fetchTRM(){
    statusEl.textContent = 'Estado: consultando API...';
    try{
      const r = await fetch(API_URL, {cache: 'no-store'});
      if(!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      if(!j || !j.rates || typeof j.rates.COP === 'undefined') throw new Error('Respuesta inesperada');
      const tasa = Number(j.rates.COP);
      if(isNaN(tasa)) throw new Error('Valor TRM no numérico');
      currentTRM = tasa;
      trmValueEl.textContent = fmt(currentTRM) + ' COP';
      trmDateEl.textContent = j.time_last_update_utc ? `actualizado: ${j.time_last_update_utc}` : '';
      updateInfoEl.textContent = `Última actualización: ${new Date().toLocaleString()}`;
      statusEl.textContent = 'Estado: OK';
      compute();
    }catch(err){
      console.error('fetchTRM error', err);
      currentTRM = null;
      trmValueEl.textContent = '—';
      trmDateEl.textContent = '';
      updateInfoEl.textContent = 'Última actualización: error';
      statusEl.innerHTML = `<span class="error">Error: ${String(err.message||err)}</span>`;
      resultEl.textContent = '—';
    }
  }

  function compute(){
    const amt = parseFloat(amountEl.value);
    if(!currentTRM || isNaN(amt)){
      resultEl.textContent = '—';
      return;
    }
    if(directionEl.value === 'usd_to_cop'){
      const res = amt * currentTRM;
      resultEl.textContent = `${fmt(res)} COP`;
    } else {
      const res = amt / currentTRM;
      resultEl.textContent = `${fmt(res)} USD`;
    }
  }

  amountEl.addEventListener('input', compute);
  directionEl.addEventListener('change', compute);
  refreshBtn.addEventListener('click', fetchTRM);

  async function start(){
    await fetchTRM();
    if(timerId) clearInterval(timerId);
    timerId = setInterval(fetchTRM, REFRESH_SECONDS*1000);
  }
  start();
})();
</script>
</body>
</html>
